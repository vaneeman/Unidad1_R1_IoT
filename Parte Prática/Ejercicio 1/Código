import network
from umqtt.simple import MQTTClient
from machine import Pin, ADC
from time import sleep

# Configuración de WiFi
WIFI_SSID = "INFINITUM0F58"          # Nombre de tu red WiFi
WIFI_PASSWORD = "xDtf3kf5zs"  # Contraseña de tu red WiFi

# Configuración de MQTT
MQTT_BROKER = "broker.emqx.io"  # Broker MQTT público
MQTT_PORT = 1883                # Puerto del broker MQTT
MQTT_TOPIC = "sensor/ldr"       # Tópico MQTT para publicar los datos
MQTT_CLIENT_ID = "esp32_ldr"    # ID único del cliente MQTT

# Configuración del LDR
ldr = ADC(Pin(34))  # Pin del LDR (conectado a un pin analógico)

# Función para conectar a WiFi
def conectar_wifi():
    print("Conectando a WiFi...", end="")
    sta_if = network.WLAN(network.STA_IF)
    sta_if.active(True)
    sta_if.connect(WIFI_SSID, WIFI_PASSWORD)
    while not sta_if.isconnected():
        print(".", end="")
        sleep(0.3)
    print(" WiFi Conectada!")
    print("IP:", sta_if.ifconfig()[0])

# Función para conectar al broker MQTT
def conectar_mqtt():
    client = MQTTClient(MQTT_CLIENT_ID, MQTT_BROKER, port=MQTT_PORT)
    client.connect()
    print("Conectado al broker MQTT")
    return client

# Conectar a WiFi
conectar_wifi()

# Conectar al broker MQTT
client = conectar_mqtt()

# Ciclo principal
while True:
    # Leer el valor del LDR
    ldr_value = ldr.read()
    print("Luminosidad:", ldr_value)

    # Publicar el valor en el tópico MQTT
    client.publish(MQTT_TOPIC, str(ldr_value))

    # Esperar 5 segundos antes de la siguiente lectura
    sleep(5)

